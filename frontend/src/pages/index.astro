---
import BaseLayout from '../layouts/BaseLayout.astro';
import BlockRenderer from '../components/BlockRenderer.astro';

const apiUrl = import.meta.env.PUBLIC_API_URL ?? 'http://localhost:8080';

let page = null;
let error = null;

try {
  const res = await fetch(`${apiUrl}/api/v1/pages/landing-page`);
  if (res.ok) {
    page = await res.json();
  } else {
    // Note: If landing-page is not created yet, it will return 404
    error = `Error ${res.status}: ${res.statusText}. Please initialize the Landing Page in the Admin panel.`;
  }
} catch (e) {
  error = 'Could not connect to the CMS API. Make sure the backend is running.';
}
---

{error && (
  <BaseLayout title="Error">
    <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;">
      <div style="background:#1e293b;border:1px solid rgba(239,68,68,0.4);border-radius:1rem;padding:3rem;max-width:560px;text-align:center;">
        <h1 style="color:#f87171;font-size:1.5rem;margin-bottom:1rem;">⚠️ API Connection Error</h1>
        <p style="color:#94a3b8;">{error}</p>
        <code style="display:block;margin-top:1.5rem;background:rgba(0,0,0,0.4);padding:1rem;border-radius:0.5rem;color:#a5b4fc;font-size:0.9rem;">
          GET {apiUrl}/api/v1/pages/landing-page
        </code>
      </div>
    </div>
  </BaseLayout>
)}

{page && (
  <BaseLayout title={page.title || 'Inicio'} seoTitle={page.seoTitle}>
    {page.blocks && page.blocks.length > 0 ? (
      page.blocks
        .sort((a: any, b: any) => a.sortOrder - b.sortOrder)
        .map((block: any) => (
          <BlockRenderer block={block} />
        ))
    ) : (
      <div style="display:flex;align-items:center;justify-content:center;min-height:50vh;padding:2rem;text-align:center;color:#64748b;">
        <h2>La Landing Page está vacía.</h2>
        <p>Agrega bloques desde el panel de administración.</p>
      </div>
    )}
  </BaseLayout>
)}
